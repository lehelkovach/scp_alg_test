# SCP - Symbolic Consistency Probing

A hypergraph-based hallucination detection system that verifies LLM outputs against a knowledge base using embeddings and symbolic reasoning.

## Overview

SCP (Symbolic Consistency Probing) addresses a key challenge in LLM deployment: **detecting hallucinations** - plausible-sounding but factually incorrect statements generated by language models.

### How It Works

1. **Knowledge Base**: Facts are stored as a hypergraph where relation nodes connect entity nodes
2. **Claim Extraction**: LLM outputs are parsed into subject-predicate-object triples
3. **Probing**: Each claim is checked against the KB using embeddings or string similarity
4. **Verdict**: Claims receive verdicts: PASS, SOFT_PASS, FAIL, or CONTRADICT

### Key Features

- **Hypergraph Structure**: N-ary relations and rich metadata support
- **Embedding-based Matching**: Semantic similarity via sentence-transformers
- **False Attribution Detection**: Catches "Edison invented the telephone" type errors
- **Contradiction Detection**: Identifies direct conflicts with known facts
- **Proof Subgraphs**: Returns evidence for verified claims

## Installation

```bash
pip install networkx numpy sentence-transformers pytest
```

Or use the requirements file:

```bash
pip install -r requirements.txt
```

## Quick Start

```python
from test import HyperKB, SCPProber, RuleBasedExtractor, SentenceTransformerBackend

# Create KB with embeddings
backend = SentenceTransformerBackend("all-MiniLM-L6-v2")
kb = HyperKB(embedding_backend=backend)

# Add facts
kb.add_fact("Albert Einstein", "discovered", "the theory of relativity")
kb.add_fact("Alexander Graham Bell", "invented", "the telephone")

# Create prober
prober = SCPProber(kb=kb, extractor=RuleBasedExtractor(), soft_threshold=0.70)

# Probe text for hallucinations
report = prober.probe("Einstein discovered relativity.")
print(f"Verdict: {report.results[0].verdict.value}")  # SOFT_PASS

# Detect hallucinations
report = prober.probe("Edison invented the telephone.")
print(f"Verdict: {report.results[0].verdict.value}")  # FAIL (false attribution)
```

## Verdict Types

| Verdict | Meaning |
|---------|---------|
| **PASS** | Exact match found in KB |
| **SOFT_PASS** | Semantic match above threshold (embeddings) |
| **FAIL** | No supporting evidence OR false attribution |
| **CONTRADICT** | Directly conflicts with a known fact |
| **UNKNOWN** | No claims could be extracted |

## Example Output

```
================================================================================
SCP CONSISTENCY REPORT
================================================================================
Text: Thomas Edison invented the telephone.
Claims extracted: 1
Overall score: 0.000
Pass rate: 0.0%
--------------------------------------------------------------------------------

[Claim 1]
  Raw: Thomas Edison invented the telephone.
  Triple: (Thomas Edison) --[invented]--> (the telephone)
  Verdict: FAIL (score=0.000)
  Matched: ('Alexander Graham Bell', 'invented', 'the telephone')
  Reason: False attribution: KB has (Alexander Graham Bell) --[invented]--> 
          (the telephone), not (Thomas Edison).
================================================================================
```

## Architecture

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   LLM Output    │────▶│  ClaimExtractor  │────▶│     Claims      │
│   (text)        │     │ (Rule/LLM/Hybrid)│     │ (s, p, o triples)│
└─────────────────┘     └──────────────────┘     └────────┬────────┘
                                                          │
┌─────────────────┐     ┌──────────────────┐     ┌────────▼────────┐
│  ProbeResult    │◀────│   SCPProber      │◀────│    HyperKB      │
│ (Verdict+Proof) │     │  (Main Engine)   │     │  (Hypergraph)   │
└─────────────────┘     └──────────────────┘     └─────────────────┘
                                                          │
                        ┌──────────────────┐              │
                        │ EmbeddingBackend │◀─────────────┘
                        │(SentenceTransformer)│
                        └──────────────────┘
```

## Running Tests

```bash
# Run all tests
python -m pytest test_scp.py -v

# Run demo
python test.py
```

## API Keys

**No API keys required!** The system uses:
- **sentence-transformers**: Local embeddings (no API needed)
- **Rule-based extraction**: No LLM needed for claim extraction

Optional LLM-based extraction is supported but not required.

## Known Limitations

1. **Coreference Resolution**: Pronouns like "She" can't be resolved to their antecedent without context
2. **Complex Claims**: Multi-hop reasoning not yet supported
3. **KB Coverage**: Detection only works for facts in the KB

## Files

- `test.py` - Main SCP implementation
- `test_scp.py` - Comprehensive test suite (58 tests)
- `requirements.txt` - Dependencies

## License

MIT
